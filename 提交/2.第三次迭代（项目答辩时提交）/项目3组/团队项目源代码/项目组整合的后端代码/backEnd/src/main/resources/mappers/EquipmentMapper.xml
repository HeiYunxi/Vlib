<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fzsx.vlib.mapper.EquipmentMapper">

    <insert id="saveEquipmentInfo" parameterType="com.fzsx.vlib.entity.Equipment">
        insert into equipment
        (equipmentName, equipmentNumber, type,
         software_system, software_version, supplier, status, purpose,
         thumbnail, create_time, update_time)
        values (#{equipmentName}, #{equipmentNumber}, #{type},
                #{software_system}, #{software_version}, #{supplierId}, #{status}, #{purpose},
                #{thumbnail}, #{create_time}, #{update_time})
    </insert>

    <select id="getEquipmentId" parameterType="com.fzsx.vlib.entity.Equipment" resultType="int">
        select `equipmentId`
        from equipment
        where equipmentNumber = #{equipmentNumber}
    </select>

    <select id="getEquipmentByEquipmentName" resultType="com.fzsx.vlib.entity.Equipment">
        select `equipmentId`, `equipmentNumber`, `type`
        from equipment
        where equipmentName = #{value}
    </select>

    <!-- 用户信息分页查询-->
    <select id="queryEquipmentList" parameterType="com.fzsx.vlib.entity.Equipment"
            resultType="map">
        select
        equipmentId,
        equipmentName,
        equipmentNumber,
        type,
        software_system,
        software_version,
        supplierId,
        supplierName,
        status,
        purpose,
        thumbnail
        from equipment e
        left join supplier s on s.supplierId = e.supplier
        <where>
            <if test="equipment.equipmentName != null and equipment.equipmentName != ''">
                and e.equipmentName like concat('%', #{equipment.equipmentName}, '%')
            </if>
            <if test="flag == 1">
                and e.status = 1
            </if>

        </where>
    </select>


    <delete id="delete" parameterType="com.fzsx.vlib.entity.Equipment">
        delete
        from equipment
        where equipmentId = #{equipmentId}
    </delete>

    <!-- 设备详细信息-->
    <select id="detail" parameterType="com.fzsx.vlib.entity.Equipment"
            resultType="map">
        select supplierId,supplierName, e.equipmentId, equipmentName, equipmentNumber, type, software_system, software_version, supplier, status, purpose, thumbnail, create_time, update_time from
        (SELECT s.supplierId,s.supplierName,es.equipmentId
        FROM supplier s
        left outer JOIN equipment_supplier es ON es.supplierId = s.supplierId) a
        right outer join equipment e ON e.equipmentId = a.equipmentId
        <where>
            <if test="equipmentId != null and equipmentId != ''">
                and e.equipmentId = #{equipmentId}
            </if>
        </where>
    </select>

    <!--更新设备信息 -->
    <update id="update" parameterType="com.fzsx.vlib.entity.Equipment">
        update equipment
        set
        <if test="equipmentName != null and equipmentName != ''">
            equipmentName=#{equipmentName},
        </if>
        <if test="equipmentNumber != null and equipmentNumber != ''">
            equipmentNumber=#{equipmentNumber},
        </if>
        <if test="type != null and type != ''">
            type=#{type},
        </if>
        <if test="software_system != null and software_system != ''">
            software_system=#{software_system},
        </if>
        <if test="software_version != null and software_version != ''">
            software_version=#{software_version},
        </if>
        <if test="supplierId != null and supplierId != ''">
            supplier=#{supplierId},
        </if>
        <if test="status != null and status != ''">
            status=#{status},
        </if>
        <if test="purpose != null and purpose != ''">
            purpose=#{purpose},
        </if>
        <if test="thumbnail != null and thumbnail != ''">
            thumbnail=#{thumbnail},
        </if>
        <if test="create_time != null ">
            create_time=#{create_time},
        </if>
        <if test="update_time != null">
            update_time=#{update_time}
        </if>

        where equipmentId=#{equipmentId}
    </update>

    <!-- 查询用户预定设备信息-->
    <select id="queryUserEquipmentList" parameterType="com.fzsx.vlib.entity.Equipment" resultType="com.fzsx.vlib.entity.Equipment">
        select * from(
        select equipmentId,(
        select equipmentName from equipment b
        where b.equipmentId=a.equipmentId
        <if test="userId != null">
            and userId=#{userId}
        </if>
        ) equipmentName from user_equipment a
        ) as temp
        <where>
            <if test="equipment.equipmentName != null and equipment.equipmentName != ''">
                and temp.equipmentName like concat('%', #{equipment.equipmentName}, '%')
            </if>
        </where>
    </select>

    <!--查询设备是否可预定 -->
    <select id="getEquipmentStatusById" resultType="com.fzsx.vlib.entity.Equipment">
        select *
        from equipment
        where equipmentId = #{equipmentId}
          and status = 1
    </select>

    <!--预定设备 -->
    <update id="booking" parameterType="com.fzsx.vlib.entity.Equipment">
        update equipment
        set
            status=2,
        <if test="update_time != null">
            update_time=#{update_time}
        </if>

        where equipmentId=#{equipmentId}
    </update>

    <insert id="booking_userEquipmentInfo" parameterType="java.util.HashMap" >
        insert into user_equipment (userId,equipmentId) values (#{userId},#{equipmentId})
    </insert>


    <!--归还设备 -->
    <update id="finishBooking" parameterType="com.fzsx.vlib.entity.Equipment">
        update equipment
        set
            status=1,
        <if test="update_time != null">
            update_time=#{update_time}
        </if>

        where equipmentId=#{equipmentId}
    </update>

    <delete id="finishBooking_userEquipmentInfo" parameterType="java.util.HashMap" >
        delete
        from user_equipment
        where userId = #{userId}
          and equipmentId = #{equipmentId}
    </delete>

    <!--查询设备是否已预定 -->
    <select id="getEquipmentFinishStatusById" resultType="com.fzsx.vlib.entity.Equipment">
        select *
        from equipment
        where equipmentId = #{equipmentId} and status = 2
    </select>

</mapper>